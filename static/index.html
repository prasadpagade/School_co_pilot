<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#667eea">
    <title>Denali School Copilot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            height: 80vh;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                height: 100vh;
                max-height: 100vh;
                box-shadow: none;
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 12px;
            }
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.5;
            overflow-wrap: break-word;
        }

        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 14px;
            }
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message-bubble strong {
            font-weight: 600;
            color: #333;
        }

        .message-bubble em {
            font-style: italic;
            color: #555;
        }

        .message-bubble code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #d63384;
        }

        .message-bubble ul {
            margin: 10px 0;
            padding-left: 24px;
            list-style-type: disc;
        }

        .message-bubble li {
            margin: 6px 0;
            line-height: 1.6;
        }

        .message-bubble li strong {
            font-weight: 600;
        }

        .message-bubble br {
            line-height: 1.6;
        }

        .message-bubble p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            padding: 0 8px;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-wrapper textarea {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            outline: none;
            transition: border-color 0.3s;
            -webkit-appearance: none;
        }

        @media (max-width: 768px) {
            .input-container {
                padding: 12px;
            }

            .input-wrapper {
                gap: 8px;
            }

            .input-wrapper textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px 14px;
                min-height: 44px; /* Better touch target */
            }
        }

        .input-wrapper textarea:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 80px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 768px) {
            .send-button {
                padding: 12px 20px;
                min-width: 70px;
                min-height: 44px; /* Better touch target */
            }
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .status.error {
            color: #d32f2f;
            background: #ffebee;
        }

        .status.success {
            color: #388e3c;
            background: #e8f5e9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #666;
        }

        .empty-state p {
            font-size: 14px;
        }

        .example-questions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .example-question {
            padding: 6px 12px;
            background: #f0f0f0;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 768px) {
            .example-question {
                padding: 8px 14px;
                font-size: 13px;
                min-height: 36px;
                display: flex;
                align-items: center;
            }
        }

        .example-question:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .voice-button {
            padding: 12px;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 768px) {
            .voice-button {
                min-width: 44px;
                min-height: 44px;
                padding: 10px;
            }
        }

        .voice-button:hover {
            background: #e0e0e0;
            border-color: #667eea;
        }

        .voice-button.recording {
            background: #ffebee;
            border-color: #d32f2f;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .voice-button.recording svg {
            fill: #d32f2f;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .voice-button svg {
            width: 20px;
            height: 20px;
            fill: #666;
        }

        .voice-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
            min-height: 16px;
        }

        .voice-status.recording {
            color: #d32f2f;
            font-weight: 600;
        }

        .image-upload-button {
            padding: 12px;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            margin-right: 8px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 768px) {
            .image-upload-button {
                min-width: 44px;
                min-height: 44px;
                padding: 10px;
                margin-right: 6px;
            }
        }

        .image-upload-button:hover {
            background: #e0e0e0;
            border-color: #667eea;
        }

        .image-upload-button input {
            display: none;
        }

        .image-upload-button svg {
            width: 20px;
            height: 20px;
            fill: #666;
        }

        .tabs {
            display: flex;
            gap: 10px;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            flex-shrink: 0;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 60px;
            touch-action: manipulation;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .tabs {
                padding: 8px 10px;
                gap: 5px;
            }

            .tab {
                padding: 10px 12px;
                font-size: 13px;
                min-width: 70px;
            }
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
            min-height: 0; /* Important for flex children */
        }

        .tab-content.active {
            display: flex !important;
        }

        .calendar-event {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }

        .calendar-event h4 {
            margin: 0 0 8px 0;
            color: #1976d2;
        }

        .calendar-event button {
            margin-top: 8px;
            padding: 6px 12px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .schedule-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 13px;
            color: #666;
        }

        .schedule-info strong {
            color: #333;
        }

        .metrics-dashboard {
            padding: 20px;
            overflow-y: auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .metric-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .metric-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .metric-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .metric-card h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        .metric-card .value {
            font-size: 32px;
            font-weight: 700;
            margin: 0;
        }

        .metric-card .subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .chart-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .chart-container h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 150px;
            padding: 10px 0;
        }

        .bar {
            flex: 1;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 4px 4px 0 0;
            min-height: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bar:hover {
            opacity: 0.8;
            transform: scaleY(1.05);
        }

        .bar-label {
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 11px;
            color: #666;
            transform: rotate(-45deg);
            transform-origin: center;
            white-space: nowrap;
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #667eea;
        }

        .trend-line {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100px;
            padding: 10px;
            border-bottom: 2px solid #e0e0e0;
            position: relative;
        }

        .trend-point {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            position: absolute;
            transform: translateX(-50%);
        }

        .suggestion-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            font-size: 13px;
            color: #333;
        }

        .suggestion-item.warning {
            border-left-color: #f5576c;
            background: #fff5f5;
        }

        .suggestion-item.success {
            border-left-color: #38ef7d;
            background: #f0fff4;
        }

        .question-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .question-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-item .count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìò Denali School Copilot</h1>
            <p>Ask questions about school events, announcements, and activities</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('chat', this)">üí¨ Chat</button>
            <button class="tab" onclick="switchTab('calendar', this)">üìÖ Calendar</button>
            <button class="tab" onclick="switchTab('schedule', this)">‚è∞ Schedule</button>
            <button class="tab" onclick="switchTab('metrics', this)">üìä Metrics</button>
        </div>

        <div class="tab-content active" id="chatTab">
        <div class="chat-container" id="chatContainer">
            <div class="empty-state">
                <h3>Welcome to Denali School Copilot!</h3>
                <p>Ask me anything about school events, field trips, announcements, and more.</p>
                <div class="example-questions">
<div class="example-question" onclick="askQuestion('What events are happening at school this week?')">What events are happening this week?</div>
                    <div class="example-question" onclick="askQuestion('When is the next field trip?')">When is the next field trip?</div>
                    <div class="example-question" onclick="askQuestion('What are the latest school announcements?')">What are the latest announcements?</div>
                    <div class="example-question" onclick="askQuestion('What is the dress code?')">What is the dress code?</div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 1px solid #90caf9;">
                    <p style="margin: 0 0 10px 0; color: #1976d2; font-weight: 600;">üìÖ Test Calendar Features:</p>
                    <div class="example-question" onclick="askQuestion('Add Music class on December 15th at 3pm')" style="margin-bottom: 8px;">Add Music class on December 15th at 3pm</div>
                    <div class="example-question" onclick="askQuestion('Create reminder for field trip tomorrow')" style="margin-bottom: 8px;">Create reminder for field trip tomorrow</div>
                    <div class="example-question" onclick="askQuestion('Schedule parent teacher conference next week')">Schedule parent teacher conference next week</div>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <label class="image-upload-button" title="Upload conversation image">
                    <input type="file" accept="image/*" onchange="handleImageUpload(event)" style="display: none;">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                </label>
                <button class="voice-button" id="voiceButton" onclick="toggleVoiceInput()" title="Click to speak">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </button>
                <textarea 
                    id="questionInput" 
                    placeholder="Ask a question about Denali's school..."
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                ></textarea>
                <button class="send-button" id="sendButton" onclick="sendQuestion()">
                    Send
                </button>
            </div>
            <div class="voice-status" id="voiceStatus"></div>
        </div>

        <div class="status" id="status"></div>
        </div>
        </div>

        <div class="tab-content" id="calendarTab">
            <div class="chat-container" style="padding: 20px; overflow-y: auto; flex: 1;">
                <h3 style="margin-bottom: 15px;">üì∏ Upload Conversation Image</h3>
                <p style="margin-bottom: 15px; color: #666;">Take a screenshot of a conversation (SMS, WhatsApp, etc.) and upload it. We'll extract dates and create calendar events automatically.</p>
                
                <div style="margin-bottom: 20px;">
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <button onclick="document.getElementById('imageInput').click()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                        üì∑ Choose Image
                    </button>
                </div>

                <div id="extractedEvents" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div class="tab-content" id="scheduleTab">
            <div class="chat-container" style="padding: 20px; overflow-y: auto; flex: 1;">
                <h3 style="margin-bottom: 15px;">‚è∞ Email Ingestion Schedule</h3>
                <div class="schedule-info" id="scheduleInfo">
                    <p>Loading schedule information...</p>
                </div>
                
                <div style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üìß Recent Emails & Announcements</h3>
                        <button onclick="checkNewEmails()" 
                                style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;"
                                onmouseover="this.style.background='#5568d3'" 
                                onmouseout="this.style.background='#667eea'">
                            üîÑ Check for New Emails
                        </button>
                    </div>
                    <div id="emailNotification" style="margin-bottom: 15px;"></div>
                    <div id="recentEmails" style="margin-top: 10px;">
                        <p>Loading recent emails...</p>
                    </div>
                </div>
                
                <p style="margin-top: 20px; color: #666; font-size: 14px;">
                    <strong>How it works:</strong> The app automatically fetches new emails from Gmail every day at the scheduled time. 
                    These emails are processed and uploaded to the knowledge base, so you can ask questions about the latest school information.
                </p>
            </div>
        </div>

        <div class="tab-content" id="metricsTab">
            <div class="metrics-dashboard" style="overflow-y: auto; flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">üìä RAG Performance Dashboard</h3>
                    <button onclick="loadMetrics()" 
                            style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                        üîÑ Refresh
                    </button>
                </div>
                <div id="metricsContent">
                    <p>Loading metrics...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect API URL for production vs development
        // If accessing via IP address (local network) or localhost, use port 8000
        // Otherwise use the same origin (production)
        function getApiUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            
            // Local development (localhost, 127.0.0.1, or local IP like 192.168.x.x)
            // Always use HTTP for local network IPs
            if (hostname === 'localhost' || 
                hostname === '127.0.0.1' || 
                hostname.match(/^192\.168\.\d+\.\d+$/) ||
                hostname.match(/^10\.\d+\.\d+\.\d+$/) ||
                hostname.match(/^172\.(1[6-9]|2[0-9]|3[0-1])\.\d+\.\d+$/)) {
                // Force HTTP for local network access
                return `http://${hostname}:8000/chat`;
            }
            
            // Production - use same origin (respects protocol)
            return `${window.location.origin}/chat`;
        }
        
        const API_URL = getApiUrl();
        console.log('API URL:', API_URL);
        const chatContainer = document.getElementById('chatContainer');
        const questionInput = document.getElementById('questionInput');
        const sendButton = document.getElementById('sendButton');
        const status = document.getElementById('status');
        const voiceButton = document.getElementById('voiceButton');
        const voiceStatus = document.getElementById('voiceStatus');

        // Speech Recognition setup
        let recognition = null;
        let isRecording = false;

        // Check for browser support
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isRecording = true;
                voiceButton.classList.add('recording');
                voiceStatus.textContent = 'Listening...';
                voiceStatus.classList.add('recording');
                questionInput.placeholder = 'Listening...';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                questionInput.value = transcript;
                questionInput.focus();
                
                // Check if this is a calendar command
                const calendarKeywords = ['add to calendar', 'create event', 'schedule', 'reminder', 'add calendar', 'set reminder'];
                const isCalendarCommand = calendarKeywords.some(keyword => 
                    transcript.toLowerCase().includes(keyword)
                );
                
                if (isCalendarCommand) {
                    // Handle as calendar command
                    handleVoiceCalendar(transcript);
                } else {
                    // Auto-send as regular question
                    setTimeout(() => {
                        sendQuestion();
                    }, 500);
                }
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                let errorMsg = 'Error: ';
                switch(event.error) {
                    case 'no-speech':
                        errorMsg = 'No speech detected. Try again.';
                        break;
                    case 'audio-capture':
                        errorMsg = 'No microphone found. Please check your microphone.';
                        break;
                    case 'not-allowed':
                        errorMsg = 'Microphone permission denied. Please allow microphone access.';
                        break;
                    default:
                        errorMsg = 'Speech recognition error. Please try again.';
                }
                voiceStatus.textContent = errorMsg;
                voiceStatus.classList.add('recording');
                setTimeout(() => {
                    voiceStatus.textContent = '';
                    voiceStatus.classList.remove('recording');
                }, 3000);
            };

            recognition.onend = function() {
                isRecording = false;
                voiceButton.classList.remove('recording');
                voiceStatus.textContent = '';
                voiceStatus.classList.remove('recording');
                questionInput.placeholder = 'Ask a question about Denali\'s school...';
            };
        } else {
            // Browser doesn't support speech recognition
            voiceButton.style.display = 'none';
            console.log('Speech recognition not supported in this browser');
        }

        function toggleVoiceInput() {
            if (!recognition) {
                voiceStatus.textContent = 'Voice input not supported in this browser. Please use Chrome or Edge.';
                voiceStatus.classList.add('recording');
                setTimeout(() => {
                    voiceStatus.textContent = '';
                    voiceStatus.classList.remove('recording');
                }, 3000);
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    voiceStatus.textContent = 'Error starting voice input. Please try again.';
                    voiceStatus.classList.add('recording');
                    setTimeout(() => {
                        voiceStatus.textContent = '';
                        voiceStatus.classList.remove('recording');
                    }, 3000);
                }
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendQuestion();
            }
        }

        function askQuestion(question) {
            questionInput.value = question;
            sendQuestion();
        }

        function updateStatus(message, type = '') {
            status.textContent = message;
            status.className = 'status ' + type;
            if (message) {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = 'status';
                }, 3000);
            }
        }

        function parseMarkdown(text) {
            // Enhanced markdown parser with better formatting
            let html = text;
            
            // Escape HTML first to prevent XSS
            html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Split by lines to handle lists and formatting properly
            const lines = html.split('\n');
            const processedLines = [];
            let inList = false;
            let inParagraph = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                
                if (!trimmed) {
                    if (inList) {
                        processedLines.push('</ul>');
                        inList = false;
                    }
                    if (inParagraph) {
                        processedLines.push('</p>');
                        inParagraph = false;
                    }
                    processedLines.push('');
                    continue;
                }
                
                // Detect list items (‚Ä¢, *, -, or numbered)
                const bulletMatch = trimmed.match(/^[‚Ä¢\*\-]\s+(.+)$/);
                const numberedMatch = trimmed.match(/^\d+[\.\)]\s+(.+)$/);
                
                if (bulletMatch || numberedMatch) {
                    if (inParagraph) {
                        processedLines.push('</p>');
                        inParagraph = false;
                    }
                    if (!inList) {
                        processedLines.push('<ul style="margin: 8px 0; padding-left: 20px;">');
                        inList = true;
                    }
                    const content = bulletMatch ? bulletMatch[1] : numberedMatch[1];
                    processedLines.push('<li style="margin: 4px 0; line-height: 1.6;">' + content + '</li>');
                } else {
                    if (inList) {
                        processedLines.push('</ul>');
                        inList = false;
                    }
                    
                    // Check if it's a header (ends with : and is short, or starts with #)
                    if (trimmed.endsWith(':') && trimmed.length < 80 && !trimmed.startsWith('**')) {
                        if (inParagraph) {
                            processedLines.push('</p>');
                            inParagraph = false;
                        }
                        processedLines.push(`<h4 style="margin: 16px 0 8px 0; color: #1976d2; font-weight: 600; font-size: 15px;">${trimmed}</h4>`);
                    } else {
                        if (!inParagraph) {
                            processedLines.push('<p style="margin: 8px 0; line-height: 1.6;">');
                            inParagraph = true;
                        } else {
                            processedLines.push('<br>');
                        }
                        processedLines.push(trimmed);
                    }
                }
            }
            
            // Close any open tags
            if (inList) {
                processedLines.push('</ul>');
            }
            if (inParagraph) {
                processedLines.push('</p>');
            }
            
            html = processedLines.join('\n');
            
            // Process inline formatting
            // Bold: **text** (must come before italic)
            html = html.replace(/\*\*([^*]+?)\*\*/g, '<strong style="font-weight: 600; color: #333;">$1</strong>');
            html = html.replace(/__([^_]+?)__/g, '<strong style="font-weight: 600; color: #333;">$1</strong>');
            
            // Italic: *text* (single asterisk, not part of **)
            html = html.replace(/(?<!\*)\*([^*\n]+?)\*(?!\*)/g, '<em>$1</em>');
            html = html.replace(/(?<!_)_([^_\n]+?)_(?!_)/g, '<em>$1</em>');
            
            // Code: `code`
            html = html.replace(/`([^`]+?)`/g, '<code style="background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-family: monospace; font-size: 0.9em;">$1</code>');
            
            // Highlight dates with emojis
            html = html.replace(/(üìÖ\s*)?\*\*([^*]+?)\*\*/g, (match, emoji, text) => {
                // If it looks like a date, ensure it has the emoji
                if (/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\w+\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4}/.test(text)) {
                    return `üìÖ <strong style="font-weight: 600; color: #1976d2;">${text}</strong>`;
                }
                return emoji ? match : `<strong style="font-weight: 600; color: #333;">${text}</strong>`;
            });
            
            // Clean up excessive blank lines
            html = html.replace(/\n{3,}/g, '\n\n');
            
            return html;
        }

        function addMessage(content, isUser) {
            // Remove empty state if it exists
            const emptyState = chatContainer.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            // Parse markdown for assistant messages, plain text for user messages
            if (isUser) {
                bubble.textContent = content;
            } else {
                bubble.innerHTML = parseMarkdown(content);
            }

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString();

            messageDiv.appendChild(bubble);
            messageDiv.appendChild(time);
            chatContainer.appendChild(messageDiv);

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            // Stop voice recording if active
            if (isRecording && recognition) {
                recognition.stop();
            }

            // Check if this is a calendar command (typed, not just voice)
            // More comprehensive detection
            const calendarKeywords = [
                'add to calendar', 'create event', 'schedule', 'reminder', 
                'add calendar', 'set reminder', 'add event', 'create calendar',
                'add', 'create', 'schedule', 'remind me'
            ];
            const datePatterns = [
                /\b(?:on|at|for)\s+\w+\s+\d{1,2}(?:st|nd|rd|th)?/i,
                /\b\d{1,2}(?:st|nd|rd|th)?\s+\w+/i,
                /\b(?:november|december|january|february|march|april|may|june|july|august|september|october)\s+\d{1,2}/i
            ];
            
            const hasCalendarKeyword = calendarKeywords.some(keyword => 
                question.toLowerCase().includes(keyword)
            );
            const hasDate = datePatterns.some(pattern => pattern.test(question));
            
            // If it has calendar keywords AND a date, treat as calendar command
            if (hasCalendarKeyword && hasDate) {
                // Handle as calendar command
                questionInput.value = '';
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                addMessage(question, true);
                addMessage('üîç Parsing calendar command...', false);
                handleVoiceCalendar(question);
                return;
            }

            // Add user message
            addMessage(question, true);
            questionInput.value = '';
            sendButton.disabled = true;
            sendButton.innerHTML = '<div class="loading"></div>';

            // Show loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message assistant';
            loadingMessage.id = 'loadingMessage';
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'message-bubble';
            loadingBubble.textContent = 'Thinking...';
            loadingMessage.appendChild(loadingBubble);
            chatContainer.appendChild(loadingMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question })
                });

                // Remove loading message
                loadingMessage.remove();

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to get response');
                }

                const data = await response.json();
                addMessage(data.answer, false);
                updateStatus('Response received', 'success');
                
                // Automatically extract and list calendar events found in response
                await extractAndListCalendarEvents(data.answer);

            } catch (error) {
                // Remove loading message
                loadingMessage.remove();
                addMessage(`Error: ${error.message}`, false);
                updateStatus('Error: ' + error.message, 'error');
                console.error('Error:', error);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
                questionInput.focus();
            }
        }

        // Automatically extract and list calendar events from response
        async function extractAndListCalendarEvents(responseText) {
            // Check if response contains date-like patterns
            const datePatterns = [
                /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{1,2}(?:st|nd|rd|th)?/i,
                /\b\d{1,2}(?:st|nd|rd|th)?\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*/i,
                /\b(?:Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)\s+(?:the\s+)?\d{1,2}(?:st|nd|rd|th)?/i,
                /\b\d{1,2}\/\d{1,2}\/\d{4}/,
                /\b(?:next\s+)?(?:week|month|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)/i
            ];
            
            const hasDates = datePatterns.some(pattern => pattern.test(responseText));
            
            if (hasDates) {
                // Automatically extract dates
                try {
                    const extractResponse = await fetch(`${API_URL.replace('/chat', '/extract-dates').replace('https://', 'http://')}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: responseText })
                    });

                    const extractData = await extractResponse.json();
                    
                    if (extractData.events && extractData.events.length > 0) {
                        // Show list of events found
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message assistant';
                        messageDiv.style.marginTop = '10px';
                        
                        const bubble = document.createElement('div');
                        bubble.className = 'message-bubble';
                        bubble.style.background = '#e3f2fd';
                        bubble.style.border = '1px solid #90caf9';
                        
                        let eventsHtml = `<p style="margin: 0 0 12px 0; color: #1976d2; font-weight: 600;">üìÖ Calendar Events Found (${extractData.events.length}):</p>`;
                        
                        extractData.events.forEach((event, index) => {
                            const eventDate = new Date(event.date);
                            const dateStr = eventDate.toLocaleDateString('en-US', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            });
                            const timeStr = event.time ? ` at ${event.time}` : '';
                            
                            eventsHtml += `
                                <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #1976d2;">
                                    <p style="margin: 0 0 4px 0; font-weight: 600; color: #333;">${event.title || 'Event'}</p>
                                    <p style="margin: 0; font-size: 13px; color: #666;">üìÜ ${dateStr}${timeStr}</p>
                                    <button onclick="createCalendarEvent('${(event.title || 'Event').replace(/'/g, "\\'")}', '${event.date}', '${(event.description || '').replace(/'/g, "\\'").substring(0, 100)}')" 
                                            style="margin-top: 6px; padding: 4px 10px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                        ‚ûï Add to Calendar
                                    </button>
                                </div>
                            `;
                        });
                        
                        bubble.innerHTML = eventsHtml;
                        messageDiv.appendChild(bubble);
                        chatContainer.appendChild(messageDiv);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                } catch (error) {
                    console.error('Error extracting dates:', error);
                }
            }
        }

        // Extract dates from text and add to calendar
        async function extractAndAddToCalendar(text) {
            updateStatus('Extracting dates and creating calendar events...', 'loading');
            
            try {
                // First extract dates
                const extractResponse = await fetch(`${API_URL.replace('/chat', '/extract-dates').replace('https://', 'http://')}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                const extractData = await extractResponse.json();
                
                if (!extractData.events || extractData.events.length === 0) {
                    updateStatus('No dates found in the text', 'error');
                    addMessage('‚ùå Could not extract dates from the text. Try using a voice command like "Add Music class on December 15th at 3pm"', false);
                    return;
                }

                // Create calendar events for each extracted date
                let successCount = 0;
                let errorCount = 0;
                
                for (const event of extractData.events) {
                    try {
                        const eventDate = new Date(event.date);
                        const dateStr = eventDate.toISOString().split('T')[0];
                        const timeStr = event.time ? event.time.split('-')[0].trim() : null;
                        
                        const createResponse = await fetch(`${API_URL.replace('/chat', '/create-calendar-event').replace('https://', 'http://')}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                title: event.title || 'Event',
                                date: dateStr,
                                time: timeStr,
                                description: event.description || text.substring(0, 200)
                            })
                        });

                        if (!createResponse.ok) {
                            const errorData = await createResponse.json();
                            errorCount++;
                            const errorMsg = errorData.detail || 'Unknown error';
                            addMessage(`‚ùå Failed to add "${event.title}": ${errorMsg.substring(0, 200)}`, false);
                            if (errorMsg.includes('credentials') || errorMsg.includes('not set up')) {
                                addMessage(`üìã Calendar setup required. Check Schedule tab for status.`, false);
                            }
                            continue;
                        }
                        
                        const createData = await createResponse.json();
                        if (createData.success) {
                            successCount++;
                            addMessage(`‚úÖ Added "${event.title}" to calendar (${dateStr}${timeStr ? ' at ' + timeStr : ''})`, false);
                            if (createData.event_link) {
                                const linkMsg = document.createElement('div');
                                linkMsg.className = 'message assistant';
                                const bubble = document.createElement('div');
                                bubble.className = 'message-bubble';
                                bubble.innerHTML = `<a href="${createData.event_link}" target="_blank" style="color: #1976d2; text-decoration: none;">üìÖ View in Google Calendar ‚Üí</a>`;
                                linkMsg.appendChild(bubble);
                                chatContainer.appendChild(linkMsg);
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            }
                        } else {
                            errorCount++;
                            addMessage(`‚ùå Failed to add "${event.title}": ${createData.message || 'Unknown error'}`, false);
                        }
                    } catch (error) {
                        errorCount++;
                        console.error('Error creating event:', error);
                    }
                }

                updateStatus('', '');
                if (successCount > 0) {
                    addMessage(`‚úÖ Successfully added ${successCount} event(s) to your calendar!`, false);
                }
                if (errorCount > 0) {
                    addMessage(`‚ö†Ô∏è ${errorCount} event(s) could not be created. Check server logs for details.`, false);
                }
            } catch (error) {
                updateStatus('', '');
                addMessage(`‚ùå Error: ${error.message}`, false);
            }
        }

        // Auto-resize textarea
        questionInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Focus input on load
        questionInput.focus();

        // Tab switching
        function switchTab(tabName, element) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
                targetTab.style.display = 'flex';
                console.log('Tab activated:', tabName, targetTab);
            } else {
                console.error('Tab not found:', tabName + 'Tab');
            }
            
            // Find and activate the clicked tab button
            document.querySelectorAll('.tab').forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                if (btnText.includes(tabName.toLowerCase())) {
                    btn.classList.add('active');
                }
            });
            
            // Also use element if provided
            if (element) {
                element.classList.add('active');
            }

            // Load schedule info if schedule tab
            if (tabName === 'schedule') {
                loadScheduleInfo();
                loadRecentEmails();
                // Auto-check for new emails when opening schedule tab
                checkNewEmails();
            }
            
            // Load metrics if metrics tab
            if (tabName === 'metrics') {
                loadMetrics();
            }
        }

        // Image upload handler
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Switch to calendar tab
            const calendarTabBtn = document.querySelectorAll('.tab')[1]; // Calendar is 2nd tab
            switchTab('calendar', calendarTabBtn);
            const extractedEventsDiv = document.getElementById('extractedEvents');
            extractedEventsDiv.innerHTML = '<p>Processing image...</p>';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_URL.replace('/chat', '/process-conversation-image').replace('https://', 'http://')}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success && data.created_events && data.created_events.length > 0) {
                    let html = '<h4 style="margin-bottom: 15px; color: #4caf50;">‚úÖ Calendar Events Created:</h4>';
                    data.created_events.forEach(event => {
                        if (event.event_link) {
                            html += `
                                <div class="calendar-event">
                                    <h4>${event.title}</h4>
                                    <p>Date: ${event.date}</p>
                                    <a href="${event.event_link}" target="_blank" style="color: #1976d2; text-decoration: none;">View in Calendar ‚Üí</a>
                                </div>
                            `;
                        } else if (event.error) {
                            html += `
                                <div class="calendar-event" style="background: #ffebee; border-color: #ef5350;">
                                    <h4>${event.title}</h4>
                                    <p style="color: #c62828;">Error: ${event.error}</p>
                                </div>
                            `;
                        }
                    });
                    extractedEventsDiv.innerHTML = html;
                } else if (data.events && data.events.length > 0) {
                    let html = `<h4 style="margin-bottom: 15px;">üìÖ Extracted ${data.events.length} Event(s):</h4>`;
                    data.events.forEach((event, index) => {
                        const eventDate = new Date(event.date);
                        const dateStr = eventDate.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        const timeStr = event.time ? ` at ${event.time}` : '';
                        html += `
                            <div class="calendar-event">
                                <h4>${event.title || 'Untitled Event'}</h4>
                                <p><strong>Date:</strong> ${dateStr}${timeStr}</p>
                                ${event.description ? `<p>${event.description}</p>` : ''}
                                <button onclick="createCalendarEvent('${(event.title || 'Untitled Event').replace(/'/g, "\\'")}', '${event.date}', '${(event.description || '').replace(/'/g, "\\'")}')">
                                    ‚ûï Add to Calendar
                                </button>
                            </div>
                        `;
                    });
                    extractedEventsDiv.innerHTML = html;
                } else {
                    extractedEventsDiv.innerHTML = '<p style="color: #666;">No dates or events found in the image.</p>';
                }
            } catch (error) {
                extractedEventsDiv.innerHTML = `<p style="color: #d32f2f;">Error: ${error.message}</p>`;
            }
        }

        // Handle voice calendar command
        async function handleVoiceCalendar(text) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'Parsing calendar command...';
            statusDiv.className = 'status';
            
            try {
                const response = await fetch(`${API_URL.replace('/chat', '/voice-calendar').replace('https://', 'http://')}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMsg = errorData.detail || 'Error creating calendar event';
                    statusDiv.textContent = errorMsg;
                    statusDiv.className = 'status error';
                    
                    // Show helpful setup message if credentials missing
                    if (errorMsg.includes('credentials') || errorMsg.includes('not set up')) {
                        addMessage(`‚ùå Calendar not set up. ${errorMsg}`, false);
                        addMessage(`üìã See CALENDAR_SETUP_GUIDE.md for setup instructions, or check the Schedule tab for calendar status.`, false);
                    } else {
                        addMessage(`‚ùå ${errorMsg}`, false);
                    }
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.textContent = 'Calendar event created!';
                    statusDiv.className = 'status success';
                    
                    // Show parsed details if available
                    if (data.parsed_details) {
                        const details = data.parsed_details;
                        const parsedMsg = document.createElement('div');
                        parsedMsg.className = 'message assistant';
                        const parsedBubble = document.createElement('div');
                        parsedBubble.className = 'message-bubble';
                        parsedBubble.style.background = '#e3f2fd';
                        parsedBubble.style.border = '1px solid #90caf9';
                        parsedBubble.innerHTML = `
                            <p style="margin: 0 0 8px 0; color: #1976d2; font-weight: 600;">üìã Parsed Details:</p>
                            <p style="margin: 2px 0;"><strong>Event:</strong> ${details.title || 'N/A'}</p>
                            <p style="margin: 2px 0;"><strong>Date:</strong> ${details.date ? new Date(details.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A'}</p>
                            ${details.time ? `<p style="margin: 2px 0;"><strong>Time:</strong> ${details.time}</p>` : ''}
                        `;
                        parsedMsg.appendChild(parsedBubble);
                        chatContainer.appendChild(parsedMsg);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                    
                    // Show success message
                    addMessage(data.message, false);
                    
                    if (data.event_link) {
                        // Add link to view in calendar
                        const linkMessage = document.createElement('div');
                        linkMessage.className = 'message assistant';
                        const bubble = document.createElement('div');
                        bubble.className = 'message-bubble';
                        bubble.innerHTML = `<a href="${data.event_link}" target="_blank" style="color: #1976d2; text-decoration: none;">üìÖ View in Google Calendar ‚Üí</a>`;
                        linkMessage.appendChild(bubble);
                        chatContainer.appendChild(linkMessage);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                } else {
                    statusDiv.textContent = data.message || 'Error creating calendar event';
                    statusDiv.className = 'status error';
                    
                    // Show parsed details even if failed
                    if (data.parsed_details) {
                        const details = data.parsed_details;
                        addMessage(`üìã I parsed: "${details.title}" on ${details.date ? new Date(details.date).toLocaleDateString() : 'unknown date'}`, false);
                    }
                    
                    addMessage(data.message || 'Error creating calendar event', false);
                }
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.className = 'status error';
                addMessage(`‚ùå Error: ${error.message}`, false);
            }
            
            // Clear input
            questionInput.value = '';
        }

        // Create calendar event
        async function createCalendarEvent(title, date, description) {
            try {
                const response = await fetch(`${API_URL.replace('/chat', '/create-calendar-event').replace('https://', 'http://')}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        date: date.split('T')[0], // Extract date part
                        description: description
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`‚úÖ Event "${title}" added to calendar!`);
                    if (data.event_link) {
                        window.open(data.event_link, '_blank');
                    }
                } else {
                    alert(`Error: ${data.message}`);
                }
            } catch (error) {
                alert(`Error creating calendar event: ${error.message}`);
            }
        }

        // Load schedule info
        async function loadScheduleInfo() {
            try {
                const scheduleInfo = document.getElementById('scheduleInfo');
                
                // Load schedule status
                const scheduleResponse = await fetch(`${API_URL.replace('/chat', '/schedule/status').replace('https://', 'http://')}`);
                const scheduleData = await scheduleResponse.json();
                
                // Load calendar status
                let calendarStatusHtml = '';
                try {
                    const calendarResponse = await fetch(`${API_URL.replace('/chat', '/calendar/status').replace('https://', 'http://')}`);
                    const calendarData = await calendarResponse.json();
                    
                    if (calendarData.configured && calendarData.authenticated) {
                        calendarStatusHtml = `
                            <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border: 1px solid #81c784;">
                                <p style="margin: 0 0 8px 0; color: #2e7d32; font-weight: 600;">üìÖ Calendar Status:</p>
                                <p style="margin: 0; color: #2e7d32;">‚úÖ ${calendarData.message}</p>
                            </div>
                        `;
                    } else if (calendarData.configured) {
                        calendarStatusHtml = `
                            <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffb74d;">
                                <p style="margin: 0 0 8px 0; color: #e65100; font-weight: 600;">üìÖ Calendar Status:</p>
                                <p style="margin: 0 0 10px 0; color: #e65100;">‚ö†Ô∏è ${calendarData.message}</p>
                                <p style="margin: 0; font-size: 13px; color: #666;">Try creating a calendar event to authorize access.</p>
                            </div>
                        `;
                    } else {
                        calendarStatusHtml = `
                            <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-radius: 8px; border: 1px solid #ef5350;">
                                <p style="margin: 0 0 8px 0; color: #c62828; font-weight: 600;">üìÖ Calendar Status:</p>
                                <p style="margin: 0 0 10px 0; color: #c62828;">‚ùå Calendar not set up</p>
                                <p style="margin: 0 0 10px 0; font-size: 13px; color: #666;">To enable calendar features:</p>
                                <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #666;">
                                    <li>Enable Google Calendar API</li>
                                    <li>Create OAuth credentials</li>
                                    <li>Save as credentials.json</li>
                                </ul>
                                <p style="margin: 10px 0 0 0; font-size: 12px; color: #999;">See CALENDAR_SETUP_GUIDE.md for details</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading calendar status:', error);
                }
                
                if (scheduleData.scheduled) {
                    scheduleInfo.innerHTML = `
                        <p><strong>Status:</strong> <span style="color: #4caf50;">‚úÖ Active</span></p>
                        <p><strong>Ingestion Time:</strong> ${scheduleData.ingestion_time}</p>
                        <p><strong>Next Run:</strong> ${scheduleData.next_run || 'Calculating...'}</p>
                        ${calendarStatusHtml}
                    `;
                } else {
                    scheduleInfo.innerHTML = `
                        <p><strong>Status:</strong> <span style="color: #ff9800;">‚ö†Ô∏è Not Scheduled</span></p>
                        <p>Email ingestion is not currently scheduled. Check your configuration.</p>
                        ${calendarStatusHtml}
                    `;
                }
            } catch (error) {
                document.getElementById('scheduleInfo').innerHTML = 
                    `<p style="color: #d32f2f;">Error loading schedule info: ${error.message}</p>`;
            }
        }

        // Check for new emails manually
        async function checkNewEmails() {
            const notificationDiv = document.getElementById('emailNotification');
            notificationDiv.innerHTML = '<p style="color: #666;">üîÑ Checking for new emails...</p>';
            
            try {
                const response = await fetch(`${API_URL.replace('/chat', '/check-new-emails').replace('https://', 'http://')}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.has_new) {
                    let notificationHtml = '';
                    
                    if (data.from_lobeda && data.lobeda_emails.length > 0) {
                        // Highlight Miss Lobeda emails - KEEP VISIBLE (don't auto-hide)
                        notificationHtml = `
                            <div style="padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <p style="margin: 0; font-weight: 700; color: #856404; font-size: 16px;">üéØ New Email from Miss Lobeda!</p>
                                    <button onclick="this.parentElement.parentElement.style.display='none'" 
                                            style="background: transparent; border: none; color: #856404; font-size: 18px; cursor: pointer; padding: 0 8px;">√ó</button>
                                </div>
                                ${data.lobeda_emails.map(email => `
                                    <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #ffc107;">
                                        <p style="margin: 0 0 4px 0; font-weight: 600; color: #856404; font-size: 14px;">üìß ${email.subject}</p>
                                        <p style="margin: 0; color: #856404; font-size: 12px;">${new Date(email.date).toLocaleString()}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    // General new emails notification - only show if not all are from Lobeda
                    if (data.new_emails.length > data.lobeda_emails.length) {
                        notificationHtml += `
                            <div style="padding: 12px; background: #d4edda; border: 2px solid #28a745; border-radius: 8px; margin-bottom: 10px;">
                                <p style="margin: 0; font-weight: 600; color: #155724;">‚úÖ ${data.message}</p>
                                ${data.new_emails.length > 0 ? `
                                    <div style="margin-top: 8px; font-size: 12px; color: #155724;">
                                        ${data.new_emails.slice(0, 5).map(email => `
                                            <p style="margin: 2px 0;">‚Ä¢ ${email.subject} (${new Date(email.date).toLocaleString()})</p>
                                        `).join('')}
                                        ${data.new_emails.length > 5 ? `<p style="margin: 2px 0; font-style: italic;">...and ${data.new_emails.length - 5} more</p>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    notificationDiv.innerHTML = notificationHtml;
                    
                    // Reload recent emails to show new ones
                    setTimeout(() => {
                        loadRecentEmails();
                    }, 1000);
                    
                    // Only auto-hide general notification, NOT Miss Lobeda emails
                    if (!data.from_lobeda) {
                        setTimeout(() => {
                            const generalNotif = notificationDiv.querySelector('div[style*="d4edda"]');
                            if (generalNotif) {
                                generalNotif.style.display = 'none';
                            }
                        }, 10000);
                    }
                } else {
                    notificationDiv.innerHTML = `
                        <div style="padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 10px;">
                            <p style="margin: 0; color: #666;">‚ÑπÔ∏è ${data.message}</p>
                        </div>
                    `;
                    setTimeout(() => {
                        notificationDiv.innerHTML = '';
                    }, 5000);
                }
            } catch (error) {
                notificationDiv.innerHTML = `
                    <div style="padding: 12px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 8px; margin-bottom: 10px;">
                        <p style="margin: 0; color: #721c24;">‚ùå Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Load recent emails
        async function loadRecentEmails() {
            try {
                const response = await fetch(`${API_URL.replace('/chat', '/emails/recent').replace('https://', 'http://')}`);
                const data = await response.json();
                
                const emailsDiv = document.getElementById('recentEmails');
                
                if (!data.emails || data.emails.length === 0) {
                    emailsDiv.innerHTML = '<p style="color: #666;">No emails found. Run email ingestion to fetch emails.</p>';
                    return;
                }
                
                let html = `<p style="margin-bottom: 10px; color: #666; font-size: 13px;">
                    <strong>Total emails:</strong> ${data.total_count} | 
                    <strong>Last ingestion:</strong> ${data.last_ingestion ? new Date(data.last_ingestion).toLocaleString() : 'Never'}
                </p>`;
                
                html += '<div style="max-height: 400px; overflow-y: auto;">';
                
                data.emails.forEach((email, index) => {
                    // Highlight Miss Lobeda emails
                    const isLobeda = email.sender && (email.sender.toLowerCase().includes('lobeda') || email.sender.toLowerCase().includes('grace.lobeda'));
                    const borderColor = isLobeda ? '#ffc107' : '#667eea';
                    const bgColor = isLobeda ? '#fffbf0' : '#f5f5f5';
                    
                    html += `
                        <div style="margin: 10px 0; padding: 12px; background: ${bgColor}; border-radius: 6px; border-left: 4px solid ${borderColor}; ${isLobeda ? 'box-shadow: 0 2px 4px rgba(255,193,7,0.2);' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                <p style="margin: 0; font-weight: 600; color: #333; font-size: 14px; flex: 1;">${email.subject}</p>
                                ${isLobeda ? '<span style="background: #ffc107; color: #856404; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; margin-left: 8px;">Miss Lobeda</span>' : ''}
                            </div>
                            <p style="margin: 0 0 4px 0; color: #666; font-size: 12px;">üìÖ ${email.date || 'Unknown date'}</p>
                            ${email.sender ? `<p style="margin: 0 0 4px 0; color: #888; font-size: 11px;">From: ${email.sender}</p>` : ''}
                            <p style="margin: 0; color: #888; font-size: 12px; max-height: 60px; overflow: hidden; line-height: 1.4;">${email.preview || 'No preview available'}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
                emailsDiv.innerHTML = html;
            } catch (error) {
                document.getElementById('recentEmails').innerHTML = 
                    `<p style="color: #d32f2f;">Error loading emails: ${error.message}</p>`;
            }
        }

        // Load and display metrics
        async function loadMetrics() {
            const metricsContent = document.getElementById('metricsContent');
            metricsContent.innerHTML = '<p>Loading metrics...</p>';
            
            try {
                const response = await fetch(`${API_URL.replace('/chat', '/rag/metrics').replace('https://', 'http://')}`);
                const data = await response.json();
                
                if (data.total_queries === 0) {
                    metricsContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p style="font-size: 18px; margin-bottom: 10px;">üìä No Metrics Yet</p>
                            <p>Start asking questions to see performance metrics!</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // Key Metrics Cards
                html += '<div class="metrics-grid">';
                html += `
                    <div class="metric-card info">
                        <h3>Total Queries</h3>
                        <p class="value">${data.total_queries}</p>
                        <p class="subtitle">Questions asked</p>
                    </div>
                    <div class="metric-card ${data.success_rate >= 80 ? 'success' : data.success_rate >= 70 ? 'warning' : ''}">
                        <h3>Success Rate</h3>
                        <p class="value">${data.success_rate}%</p>
                        <p class="subtitle">${data.successful_queries} successful / ${data.total_queries} total</p>
                    </div>
                    <div class="metric-card ${data.avg_quality_score >= 0.7 ? 'success' : data.avg_quality_score >= 0.5 ? 'warning' : ''}">
                        <h3>Avg Quality Score</h3>
                        <p class="value">${data.avg_quality_score.toFixed(2)}</p>
                        <p class="subtitle">Out of 1.0</p>
                    </div>
                    <div class="metric-card info">
                        <h3>Avg Response Time</h3>
                        <p class="value">${data.avg_response_time}s</p>
                        <p class="subtitle">Seconds per query</p>
                    </div>
                    <div class="metric-card success">
                        <h3>Learned Patterns</h3>
                        <p class="value">${data.learned_patterns || 0}</p>
                        <p class="subtitle">Query patterns</p>
                    </div>
                `;
                html += '</div>';
                
                // Accuracy Trend Chart
                if (data.accuracy_trend && data.accuracy_trend.length > 0) {
                    html += '<div class="chart-container">';
                    html += '<h4>üìà Accuracy Trend (Last 7 Days)</h4>';
                    html += '<div class="trend-line">';
                    const maxRate = Math.max(...data.accuracy_trend.map(d => d.success_rate || 0), 100);
                    data.accuracy_trend.forEach((day, index) => {
                        const height = (day.success_rate / maxRate) * 100;
                        const left = (index / (data.accuracy_trend.length - 1 || 1)) * 100;
                        html += `
                            <div style="position: absolute; left: ${left}%; bottom: 0;">
                                <div style="background: #667eea; width: 20px; height: ${height}px; border-radius: 4px 4px 0 0; position: relative;">
                                    <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 600; color: #667eea; white-space: nowrap;">
                                        ${day.success_rate.toFixed(1)}%
                                    </div>
                                </div>
                                <div style="position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #666; white-space: nowrap;">
                                    ${new Date(day.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
                
                // Query Type Distribution
                if (data.query_type_distribution && Object.keys(data.query_type_distribution).length > 0) {
                    html += '<div class="chart-container">';
                    html += '<h4>üìä Query Type Distribution</h4>';
                    html += '<div class="bar-chart">';
                    const types = Object.entries(data.query_type_distribution);
                    const maxCount = Math.max(...types.map(([_, count]) => count), 1);
                    types.forEach(([type, count]) => {
                        const height = (count / maxCount) * 100;
                        const label = type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                        html += `
                            <div class="bar" style="height: ${height}%">
                                <div class="bar-value">${count}</div>
                                <div class="bar-label">${label}</div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
                
                // Top Questions
                if (data.top_questions && data.top_questions.length > 0) {
                    html += '<div class="chart-container">';
                    html += '<h4>üîç Most Common Questions</h4>';
                    html += '<div class="question-list">';
                    data.top_questions.forEach(item => {
                        html += `
                            <div class="question-item">
                                <span>${item.question.substring(0, 60)}${item.question.length > 60 ? '...' : ''}</span>
                                <span class="count">${item.count}</span>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
                
                // Improvement Suggestions
                if (data.improvement_suggestions && data.improvement_suggestions.length > 0) {
                    html += '<div class="chart-container">';
                    html += '<h4>üí° Improvement Suggestions</h4>';
                    data.improvement_suggestions.forEach(suggestion => {
                        const type = suggestion.includes('‚ö†Ô∏è') ? 'warning' : suggestion.includes('‚úÖ') || suggestion.includes('üìà') ? 'success' : '';
                        html += `<div class="suggestion-item ${type}">${suggestion}</div>`;
                    });
                    html += '</div>';
                }
                
                // Recent Optimizations
                if (data.recent_optimizations && data.recent_optimizations.length > 0) {
                    html += '<div class="chart-container">';
                    html += '<h4>üîß Recent Optimizations</h4>';
                    data.recent_optimizations.forEach(opt => {
                        html += `
                            <div class="suggestion-item">
                                <strong>${opt.type || 'Optimization'}:</strong> ${opt.suggestion || JSON.stringify(opt)}
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                metricsContent.innerHTML = html;
            } catch (error) {
                metricsContent.innerHTML = `
                    <div style="padding: 20px; background: #ffebee; border: 1px solid #ef5350; border-radius: 8px; color: #c62828;">
                        <p><strong>Error loading metrics:</strong> ${error.message}</p>
                        <p style="font-size: 13px; margin-top: 10px;">Make sure the API server is running.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>

